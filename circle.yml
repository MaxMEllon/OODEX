machine:
  services:
    - docker
  ruby:
    version: 2.4.0
  node:
    version: 6.9.0
  timezone: Asia/Tokyo
  environment:
    PATH: "${PATH}:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin:${HOME}/${CIRCLE_PROJECT_REPONAME}/client/node_modules/.bin"

dependencies:
  pre:
    - gem install bundler
  override:
    - yarn
    - cd client && yarn
    - bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs=4 --retry=3
  cache_directories:
    - ~/.cache/yarn

test:
  override:
    - "bundle exec bin/rubocop": { parallel: true }
    - "RAILS_ENV=test bundle exec rails db:migrate:reset"
    - bundle exec rspec
    - bundle exec codeclimate-test-reporter
    # front
    - cd client && yarn run lint

deployment:
  deployment:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker build -t maxmellon/oodex .
      - docker tag maxmellon/oodex:latest maxmellon/oodex
      - docker push maxmellon oodex
